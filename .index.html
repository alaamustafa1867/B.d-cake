<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كيكة عيد ميلاد — H.B.D Ninjaaaa♥️</title>
  <style>
    :root{
      --cake-width: 360px;
      --cake-height: 180px;
    }
    body{
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(180deg,#fff8ec,#ffeedd);
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      direction: rtl;
    }
    .container{
      text-align:center;
      width: 100%;
      max-width: 900px;
      padding: 20px;
    }
    h1{ margin: 4px 0 12px; font-size:20px; }
    .card{
      background: rgba(255,255,255,0.85);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      display:inline-block;
    }

    /* cake */
    .cake-wrap{ position:relative; width:var(--cake-width); margin: 10px auto 0; }
    .cake{
      width:100%;
      height: var(--cake-height);
      background: linear-gradient(180deg,#f9b3c0,#f28aa1);
      border-radius: 22px;
      position:relative;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 28px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12) inset;
    }

    /* text on cake */
    .cake .message{
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-10%);
      font-weight:700;
      font-size:18px;
      color:#5b1b2b;
      text-shadow: 0 1px 0 #fff7;
      pointer-events:none;
      white-space:nowrap;
    }

    /* candles row */
    .candles-row{
      width: calc(100% - 20px);
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:4px 2px;
      position:absolute;
      top: 8px;
      left: 10px;
      right: 10px;
      padding: 0 6px;
      box-sizing:border-box;
      pointer-events:none;
    }
    .candle{
      width:6px;
      height:44px;
      background: linear-gradient(180deg,#fff3a8,#ffd54a);
      border-radius:2px;
      position:relative;
      display:inline-block;
      transform-origin:bottom center;
    }
    .candle .wick{
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      width:2px;
      height:6px;
      background:#333;
      border-radius:1px;
    }
    .candle .flame{
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translate(-50%,-8px);
      width:10px;
      height:14px;
      background: radial-gradient(circle at 40% 30%, #fff176 0 20%, orange 40%, #ff6b00 70%);
      border-radius:50% 50% 60% 40%;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: flicker 400ms infinite;
    }
    @keyframes flicker{
      0%{ transform:translate(-50%,-8px) scale(1); opacity:1 }
      50%{ transform:translate(-50%,-6px) scale(1.05); opacity:0.95 }
      100%{ transform:translate(-50%,-9px) scale(0.98); opacity:1 }
    }

    /* extinguished */
    .out .flame{ display:none; }
    .smoke{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:-30px;
      width:14px;
      height:14px;
      border-radius:50%;
      opacity:0;
      pointer-events:none;
    }
    .smoke.show{
      animation: smokeRise 1200ms ease-out forwards;
    }
    @keyframes smokeRise{
      0%{ opacity:0.8; transform:translate(-50%,0) scale(0.6) }
      50%{ opacity:0.6; transform:translate(-50%,-28px) scale(1.1) }
      100%{ opacity:0; transform:translate(-50%,-60px) scale(1.6) }
    }

    /* controls */
    .info{ margin-top:12px; font-size:14px; color:#333; }
    .btn{
      display:inline-block;
      margin-top:10px;
      background:#5b1b2b;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      text-decoration:none;
      cursor:pointer;
    }
    .status{ margin-top:8px; font-size:13px; color:#444; }
    .small{ font-size:12px; color:#666; margin-top:6px; }
    @media (max-width:420px){
      :root{ --cake-width: 300px; --cake-height:150px; }
      .candle{ height:36px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>كيكة عيد الميلاد 🎂</h1>
      <div class="cake-wrap" id="cake-wrap">
        <div class="cake" id="cake">
          <div class="message">H.B.D Ninjaaaa♥️</div>
          <div class="candles-row" id="candles-row"></div>
        </div>
      </div>

      <div class="info">
        <div class="status" id="status">اضغطي "بدء الميكروفون" و نفخي في المايك عشان تطفي الشمع.</div>
        <button id="startBtn" class="btn">بدء الميكروفون</button>
        <div class="small">لو فتحتي الرابط مع باراميتر `?candles=X`، ممكن تغيّري عدد الشموع. (حسب الصفحة، الافتراضي 29)</div>
      </div>
    </div>
  </div>

  <script>
    // إعداد عدد الشموع — الافتراضي 29، يمكن تغييره عن طريق باراميتر ?candles=#
    const params = new URLSearchParams(window.location.search);
    let numCandles = parseInt(params.get('candles'));
    if (!Number.isFinite(numCandles) || numCandles <= 0) numCandles = 29;

    const candlesRow = document.getElementById('candles-row');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const cakeWrap = document.getElementById('cake-wrap');

    // إنشاء الشموع
    function createCandles(n){
      candlesRow.innerHTML = '';
      for(let i=0;i<n;i++){
        const c = document.createElement('div');
        c.className = 'candle';
        // لتوليد تنوع بسيط في الارتفاع والدوران
        c.style.transform = 'translateY(0) rotate(' + ((Math.random()-0.5)*6) + 'deg)';
        const wick = document.createElement('div');
        wick.className = 'wick';
        const flame = document.createElement('div');
        flame.className = 'flame';
        c.appendChild(wick);
        c.appendChild(flame);
        candlesRow.appendChild(c);
      }
    }
    createCandles(numCandles);
    statusEl.textContent = `عدد الشموع: ${numCandles} — اضغطي "بدء الميكروفون" و انفُخي.`

    // ميكانيكية الاستماع للنفخ
    let audioContext, analyser, micStream, dataArray;
    let listening = false;
    let extinguished = false;

    // مُراقب حجم الصوت (RMS) لحساسية النفخ
    function computeRMS(buf){
      let sum = 0;
      for(let i=0;i<buf.length;i++){
        const v = (buf[i] - 128) / 128; // normalize -1..1
        sum += v*v;
      }
      return Math.sqrt(sum / buf.length);
    }

    // بدء الميكروفون
    async function startMic(){
      if(listening) return;
      try{
        startBtn.disabled = true;
        startBtn.textContent = 'جارٍ الوصول للميكروفون...';
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        const source = audioContext.createMediaStreamSource(micStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.fftSize);
        listening = true;
        startBtn.textContent = 'الميكروفون شغال — أنفخي الآن';
        statusEl.textContent = 'استماع... انفخي بقوة متوسطة إلى عالية ليتم اكتشاف النفخة.';
        monitor();
      }catch(err){
        console.error(err);
        statusEl.textContent = 'لم يتم منح إذن الميكروفون أو حدث خطأ.';
        startBtn.disabled = false;
        startBtn.textContent = 'بدء الميكروفون';
      }
    }

    // متغيرات للكشف الذكي: نستخدم متوسط متحرك + عتبة
    let avg = 0;
    let alpha = 0.02; // سرعة المتوسط المتحرك
    const THRESHOLD = 0.18; // ممكن تزوديها لو الصفحة تكشف نغمات عادية بدل النفخ

    function monitor(){
      if(!analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      const rms = computeRMS(dataArray); // 0 .. ~0.6
      // تحديث المتوسط المتحرك
      avg = (1 - alpha) * avg + alpha * rms;

      // كشف نفخة: rms أعلى من avg * factor OR أعلى من absolute threshold
      if(!extinguished && (rms > Math.max(avg * 2.2, THRESHOLD))){
        extinguishAll();
      }
      requestAnimationFrame(monitor);
    }

    function extinguishAll(){
      extinguished = true;
      statusEl.textContent = 'تمام! الشمع طفى 🎉';
      // إظهار دخان مؤقتاً عند منتصف الكيك
      const smoke = document.createElement('div');
      smoke.className = 'smoke show';
      // ألوان دخان بسيطة باستخدام تدرجات عبر CSS inline
      smoke.style.background = 'radial-gradient(circle at 30% 30%, rgba(200,200,200,0.9), rgba(150,150,150,0.5))';
      cakeWrap.appendChild(smoke);

      // إخفاء اللهب (إضافة كلاس out)
      const candles = document.querySelectorAll('.candle');
      candles.forEach((c, idx) => {
        // مؤثر تأخير صغير لعمل تأثير تسلسل
        setTimeout(()=>{
          c.classList.add('out');
        }, idx * 12); // كل شمعة تتطفي بعد 12ms إضافي -> انطباع تسلسل سريع
      });

      // اغلاق الميكروفون بعد قليل لخصوصية
      setTimeout(stopMic, 1200);
    }

    function stopMic(){
      if(micStream){
        const tracks = micStream.getTracks();
        tracks.forEach(t => t.stop());
      }
      if(audioContext) audioContext.close && audioContext.close();
      listening = false;
      startBtn.disabled = false;
      startBtn.textContent = 'بدء الميكروفون';
    }

    // زر البدء
    startBtn.addEventListener('click', startMic);

    // لو حابّة ترجعِ الشمع تاني (اختياري) — بتعمل إعادة تحميل الصفحة
    // أو ممكن نضيف زر لإعادة إشعال الشموع؛ أبقي قولي لو تحبي.
  </script>
</body>
</html>
