<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒÙŠÙƒØ© Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯ â€” H.B.D Ninjaaaaâ™¥ï¸</title>
  <style>
    :root{
      --cake-width: 360px;
      --cake-height: 180px;
    }
    body{
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(180deg,#fff8ec,#ffeedd);
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      direction: rtl;
    }
    .container{
      text-align:center;
      width: 100%;
      max-width: 900px;
      padding: 20px;
    }
    h1{ margin: 4px 0 12px; font-size:20px; }
    .card{
      background: rgba(255,255,255,0.85);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      display:inline-block;
    }

    /* cake */
    .cake-wrap{ position:relative; width:var(--cake-width); margin: 10px auto 0; }
    .cake{
      width:100%;
      height: var(--cake-height);
      background: linear-gradient(180deg,#f9b3c0,#f28aa1);
      border-radius: 22px;
      position:relative;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 28px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12) inset;
    }

    /* text on cake */
    .cake .message{
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-10%);
      font-weight:700;
      font-size:18px;
      color:#5b1b2b;
      text-shadow: 0 1px 0 #fff7;
      pointer-events:none;
      white-space:nowrap;
    }

    /* candles row */
    .candles-row{
      width: calc(100% - 20px);
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:4px 2px;
      position:absolute;
      top: 8px;
      left: 10px;
      right: 10px;
      padding: 0 6px;
      box-sizing:border-box;
      pointer-events:none;
    }
    .candle{
      width:6px;
      height:44px;
      background: linear-gradient(180deg,#fff3a8,#ffd54a);
      border-radius:2px;
      position:relative;
      display:inline-block;
      transform-origin:bottom center;
    }
    .candle .wick{
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      width:2px;
      height:6px;
      background:#333;
      border-radius:1px;
    }
    .candle .flame{
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translate(-50%,-8px);
      width:10px;
      height:14px;
      background: radial-gradient(circle at 40% 30%, #fff176 0 20%, orange 40%, #ff6b00 70%);
      border-radius:50% 50% 60% 40%;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: flicker 400ms infinite;
    }
    @keyframes flicker{
      0%{ transform:translate(-50%,-8px) scale(1); opacity:1 }
      50%{ transform:translate(-50%,-6px) scale(1.05); opacity:0.95 }
      100%{ transform:translate(-50%,-9px) scale(0.98); opacity:1 }
    }

    /* extinguished */
    .out .flame{ display:none; }
    .smoke{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:-30px;
      width:14px;
      height:14px;
      border-radius:50%;
      opacity:0;
      pointer-events:none;
    }
    .smoke.show{
      animation: smokeRise 1200ms ease-out forwards;
    }
    @keyframes smokeRise{
      0%{ opacity:0.8; transform:translate(-50%,0) scale(0.6) }
      50%{ opacity:0.6; transform:translate(-50%,-28px) scale(1.1) }
      100%{ opacity:0; transform:translate(-50%,-60px) scale(1.6) }
    }

    /* controls */
    .info{ margin-top:12px; font-size:14px; color:#333; }
    .btn{
      display:inline-block;
      margin-top:10px;
      background:#5b1b2b;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      text-decoration:none;
      cursor:pointer;
    }
    .status{ margin-top:8px; font-size:13px; color:#444; }
    .small{ font-size:12px; color:#666; margin-top:6px; }
    @media (max-width:420px){
      :root{ --cake-width: 300px; --cake-height:150px; }
      .candle{ height:36px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ÙƒÙŠÙƒØ© Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ğŸ‚</h1>
      <div class="cake-wrap" id="cake-wrap">
        <div class="cake" id="cake">
          <div class="message">H.B.D Ninjaaaaâ™¥ï¸</div>
          <div class="candles-row" id="candles-row"></div>
        </div>
      </div>

      <div class="info">
        <div class="status" id="status">Ø§Ø¶ØºØ·ÙŠ "Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†" Ùˆ Ù†ÙØ®ÙŠ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø¹Ø´Ø§Ù† ØªØ·ÙÙŠ Ø§Ù„Ø´Ù…Ø¹.</div>
        <button id="startBtn" class="btn">Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</button>
        <div class="small">Ù„Ùˆ ÙØªØ­ØªÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± `?candles=X`ØŒ Ù…Ù…ÙƒÙ† ØªØºÙŠÙ‘Ø±ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹. (Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 29)</div>
      </div>
    </div>
  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹ â€” Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 29ØŒ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± ?candles=#
    const params = new URLSearchParams(window.location.search);
    let numCandles = parseInt(params.get('candles'));
    if (!Number.isFinite(numCandles) || numCandles <= 0) numCandles = 29;

    const candlesRow = document.getElementById('candles-row');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const cakeWrap = document.getElementById('cake-wrap');

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù…ÙˆØ¹
    function createCandles(n){
      candlesRow.innerHTML = '';
      for(let i=0;i<n;i++){
        const c = document.createElement('div');
        c.className = 'candle';
        // Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ†ÙˆØ¹ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Ù†
        c.style.transform = 'translateY(0) rotate(' + ((Math.random()-0.5)*6) + 'deg)';
        const wick = document.createElement('div');
        wick.className = 'wick';
        const flame = document.createElement('div');
        flame.className = 'flame';
        c.appendChild(wick);
        c.appendChild(flame);
        candlesRow.appendChild(c);
      }
    }
    createCandles(numCandles);
    statusEl.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹: ${numCandles} â€” Ø§Ø¶ØºØ·ÙŠ "Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†" Ùˆ Ø§Ù†ÙÙØ®ÙŠ.`

    // Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù†ÙØ®
    let audioContext, analyser, micStream, dataArray;
    let listening = false;
    let extinguished = false;

    // Ù…ÙØ±Ø§Ù‚Ø¨ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØª (RMS) Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù†ÙØ®
    function computeRMS(buf){
      let sum = 0;
      for(let i=0;i<buf.length;i++){
        const v = (buf[i] - 128) / 128; // normalize -1..1
        sum += v*v;
      }
      return Math.sqrt(sum / buf.length);
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
    async function startMic(){
      if(listening) return;
      try{
        startBtn.disabled = true;
        startBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...';
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        const source = audioContext.createMediaStreamSource(micStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.fftSize);
        listening = true;
        startBtn.textContent = 'Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø´ØºØ§Ù„ â€” Ø£Ù†ÙØ®ÙŠ Ø§Ù„Ø¢Ù†';
        statusEl.textContent = 'Ø§Ø³ØªÙ…Ø§Ø¹... Ø§Ù†ÙØ®ÙŠ Ø¨Ù‚ÙˆØ© Ù…ØªÙˆØ³Ø·Ø© Ø¥Ù„Ù‰ Ø¹Ø§Ù„ÙŠØ© Ù„ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù†ÙØ®Ø©.';
        monitor();
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£.';
        startBtn.disabled = false;
        startBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
      }
    }

    // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ÙƒØ´Ù Ø§Ù„Ø°ÙƒÙŠ: Ù†Ø³ØªØ®Ø¯Ù… Ù…ØªÙˆØ³Ø· Ù…ØªØ­Ø±Ùƒ + Ø¹ØªØ¨Ø©
    let avg = 0;
    let alpha = 0.02; // Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
    const THRESHOLD = 0.18; // Ù…Ù…ÙƒÙ† ØªØ²ÙˆØ¯ÙŠÙ‡Ø§ Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© ØªÙƒØ´Ù Ù†ØºÙ…Ø§Øª Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¯Ù„ Ø§Ù„Ù†ÙØ®

    function monitor(){
      if(!analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      const rms = computeRMS(dataArray); // 0 .. ~0.6
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
      avg = (1 - alpha) * avg + alpha * rms;

      // ÙƒØ´Ù Ù†ÙØ®Ø©: rms Ø£Ø¹Ù„Ù‰ Ù…Ù† avg * factor OR Ø£Ø¹Ù„Ù‰ Ù…Ù† absolute threshold
      if(!extinguished && (rms > Math.max(avg * 2.2, THRESHOLD))){
        extinguishAll();
      }
      requestAnimationFrame(monitor);
    }

    function extinguishAll(){
      extinguished = true;
      statusEl.textContent = 'ØªÙ…Ø§Ù…! Ø§Ù„Ø´Ù…Ø¹ Ø·ÙÙ‰ ğŸ‰';
      // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø®Ø§Ù† Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„ÙƒÙŠÙƒ
      const smoke = document.createElement('div');
      smoke.className = 'smoke show';
      // Ø£Ù„ÙˆØ§Ù† Ø¯Ø®Ø§Ù† Ø¨Ø³ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ¯Ø±Ø¬Ø§Øª Ø¹Ø¨Ø± CSS inline
      smoke.style.background = 'radial-gradient(circle at 30% 30%, rgba(200,200,200,0.9), rgba(150,150,150,0.5))';
      cakeWrap.appendChild(smoke);

      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„Ù‡Ø¨ (Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ out)
      const candles = document.querySelectorAll('.candle');
      candles.forEach((c, idx) => {
        // Ù…Ø¤Ø«Ø± ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù„Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± ØªØ³Ù„Ø³Ù„
        setTimeout(()=>{
          c.classList.add('out');
        }, idx * 12); // ÙƒÙ„ Ø´Ù…Ø¹Ø© ØªØªØ·ÙÙŠ Ø¨Ø¹Ø¯ 12ms Ø¥Ø¶Ø§ÙÙŠ -> Ø§Ù†Ø·Ø¨Ø§Ø¹ ØªØ³Ù„Ø³Ù„ Ø³Ø±ÙŠØ¹
      });

      // Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„ Ù„Ø®ØµÙˆØµÙŠØ©
      setTimeout(stopMic, 1200);
    }

    function stopMic(){
      if(micStream){
        const tracks = micStream.getTracks();
        tracks.forEach(t => t.stop());
      }
      if(audioContext) audioContext.close && audioContext.close();
      listening = false;
      startBtn.disabled = false;
      startBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
    }

    // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    startBtn.addEventListener('click', startMic);

    // Ù„Ùˆ Ø­Ø§Ø¨Ù‘Ø© ØªØ±Ø¬Ø¹Ù Ø§Ù„Ø´Ù…Ø¹ ØªØ§Ù†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø¨ØªØ¹Ù…Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    // Ø£Ùˆ Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ Ø²Ø± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø´Ø¹Ø§Ù„ Ø§Ù„Ø´Ù…ÙˆØ¹Ø› Ø£Ø¨Ù‚ÙŠ Ù‚ÙˆÙ„ÙŠ Ù„Ùˆ ØªØ­Ø¨ÙŠ.
  </script>
</body>
</html>
